<!DOCTYPE html>
<html>
<head>
	<title>pongwars</title>

	<script type="text/javascript" src="pong/Pong.js"></script>
	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
	<script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
	<link rel="stylesheet" type="text/css" href="styles.css">
	<script type="text/javascript">		

		window.onload = function () {
			var is_master = false;
			var user = "user-"+(Math.floor(Math.random() * 100) + 1);
			var pong = new Pong(document.getElementById('pong'));
			var socket = io('pong-wars.com:3000');

			function game_start(){	
				pong.start();
				console.log("start");
				if(is_master){
		                        pong.players.a.addControls({
        		                        'up': 'up',
                		                'down': 'down',
                        		});
				} else {
		                        pong.players.b.addControls({
        	                        'up': 'up',
                	                'down': 'down',
                        		});

					pong.balls[0].updatePosition = function(){console.log("new position overriden");};

				}

			}


			function game_update(msg){
				if(is_master){
					pong.players.b.y = msg.paddel;
				} else {
					// update ball
					pong.balls[0].x = msg.ball.x;	
					pong.balls[0].y = msg.ball.y;
					// update player 
					pong.players.a.y = msg.paddel;
				}
			}
		
    			socket.on('connect',function() {
				socket.emit("message", { user_id : user } );
			 });	
			socket.on('message', function(msg){
				if( msg.master != null ){
					if ( msg.master == true ){
						master=true;
						console.log("i am the master");
					}
					else {
						console.log("i am the slave");
					}
				}
				if( msg.user_id != null ){
					game_update(msg);
					console.log("update game-state");
					
				}
				if( msg.action != null ) {
					if( msg.action == "start" ){
						game_start();
					}
				}

				console.log(msg);
			});

			function resize () {
				var gameHeight = window.innerHeight - 40 + 'px';
				document.getElementById('pong').style.height = gameHeight;

				pong.resize();
			}

			resize();
			window.onresize = resize;

			pong.on('update', function () {
				var player = pong.players.a;
				if(!is_master) player = pong.players.b;
				socket.emit('message', {user_id: user, paddel: player.y, ball: {x: pong.balls[0].x, y:pong.balls[0].y }} );

				 //if (pong.players.b.y < pong.balls[0].y) {
			        //	pong.players.b.move(1);
				// } else if (pong.players.b.y > pong.balls[0].y) {
	        		//	pong.players.b.move(-1);
				// }
    			 })

			
		};


	</script>
</head>
<body>
	<div id="pong"></div>
	<div class="panel">
		Move with [ UP ], [ DOWN ]
	</div>
</body>
</html>
