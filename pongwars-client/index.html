<!DOCTYPE html>
<html>
<head>
	<title>pongwars</title>

	<script type="text/javascript" src="pong/Pong.js"></script>
	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
	<script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
	<link rel="stylesheet" type="text/css" href="styles.css">
	<script type="text/javascript">		

		window.onload = function () {
			var is_master = false;
			var user = "user-"+(Math.floor(Math.random() * 100) + 1);
			var pong = new Pong(document.getElementById('pong'));
			var socket = io('pong-wars.com:3000');

			function ball_disable(){
				pong.balls[0].disable(true);
			}

			function ball_position(px,py){	
				pong.balls[0].position( px, py );
			}

			function set_master(){
				pong.players.a.addControls({
                                     'up': 'up',
                                     'down': 'down',
                              });
				
			}

			function set_slave(){
		                pong.players.b.addControls({
        	                        'up': 'up',
                	                'down': 'down',
                        	});
				ball_disable();
				
			}
						
			function slave_update(paddel){
				pong.players.b.y = paddel;
			}

			function master_update(paddel){
				pong.players.a.y = paddel;
			}
		
    			socket.on('connect',function() {
				socket.emit("message", { user_id : user } );
			 });
			socket.on('init', function(msg){
				is_master=msg.master;
				console.log("master?: "+is_master);
			});
			socket.on('action', function(msg){
				console.log("action:"+msg.action);
				if( msg.action == 'start' ){
					pong.start();	
				}
			});
			socket.on('message', function(msg){
				console.log(msg);
			});

			function resize () {
				var gameHeight = window.innerHeight - 40 + 'px';
				document.getElementById('pong').style.height = gameHeight;

				pong.resize();
			}

			resize();
			window.onresize = resize;
			pong.on('start', function() {
				if( is_master ) {
					set_master();
				} else {
					set_slave();
				}

			});
			var pos=0;
			pong.on('beforeupdate', function () {
				var player = pong.players.a;
				if(!is_master) player = pong.players.b;
				socket.emit('message', {user_id: user, paddel: player.y, ball: {x: pong.balls[0].x, y:pong.balls[0].y }} );

				//pos+=1;
				//slave_update(pos);
				//master_update(pos);
				//ball_position(0,pos);
			});
			
		};


	</script>
</head>
<body>
	<div id="pong"></div>
	<div class="panel">
		Move with [ UP ], [ DOWN ]
	</div>
</body>
</html>
