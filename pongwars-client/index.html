<!DOCTYPE html>
<html>
<head>
	<title>pongwars</title>

    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
	<script type="text/javascript" src="pong/Pong.js"></script>
	<link rel="stylesheet" type="text/css" href="styles.css">
	<script type="text/javascript">

        var factory = new ActivityFactory("shrink-paddle");

        factory.on('create', function(action){
           console.log("action created "+action.actionId  );
        });

        factory.on('destroy', function(action){
            console.log("action destroy "+action.actionId  );
        });
        var action1 = factory.create();
        var action2 = factory.create();

        action1.destroy();
        action2.destroy();


        window.onload = function () {
			var start=false;
			var is_master = false;
            var is_bot = false;
			var user = "user-"+(Math.floor(Math.random() * 100) + 1);
			var pong = new Pong(document.getElementById('pong'));
			var socket = io(':3000');
			var msg = null;

            function game_start(){
                start=true;
                pong.start();
            }

            function bot_start(){
                console.log("bot activated");
                socket.close();
                game_start();
            }

            $(document).keypress(function(e) {
                if(e.which == 98) {
                    is_bot=true;
                    bot_start();
                }
            });

			function ball_disable(){
				pong.balls[0].disable(true);
			}

			function ball_position(px,py){	
				pong.balls[0].position( px, py );
			}

			function set_master(){
				pong.players.a.addControls({'up': 'up', 'down': 'down' });
			}

			function set_slave(){
                pong.players.b.addControls({ 'up': 'up', 'down':'down'});
				ball_disable();
				
			}
						
			function slave_update(paddle){
                pong.players.b.y = paddle;
			}

			function master_update(paddle){
                pong.players.a.y = paddle;
			}


            socket.on('connect',function() {
				socket.emit("message", { user_id : user } );
			 });
			socket.on('init', function(msg){
				is_master=msg.master;
				console.log("master?: "+is_master);
			});

			socket.on('action', function(msg){
				console.log("action:"+msg.action);
				if( msg.action == 'start' ){
                    game_start();
				}
			});

            socket.on('message', function(msg){
				if(!is_master){
					ball_position(msg.ball.x, msg.ball.y);
					master_update(msg.paddle);
				}
				else {
					slave_update(msg.paddle);
				}	
			});

			function resize () {
                document.getElementById('pong').style.width = "1000px";
                document.getElementById('pong').style.height = "600px";
				pong.resize();
			}
			resize();

			pong.on('start', function() {
				if( is_master ) {
					set_master();
				} else {
					set_slave();
				}
            });
			pong.on('beforeupdate', function () {
				if(start){
					var player = pong.players.a;
					if(!is_master) player = pong.players.b;
                    msg =  {user_id: user, paddle: player.y, ball: {x: pong.balls[0].x, y:pong.balls[0].y }};
				}
			});

            pong.on('update', function(){
               if(is_bot) {
                   if(is_master){
                       slave_update(pong.balls[0].y);
                   }else {
                       master_update(pong.balls[0].y);
                   }
               }
            });

			setInterval( function(){ 
				if( msg != null ){
					socket.emit('message', msg );
				};
			}, 10);
			
		};


	</script>
</head>
<body>
	<div id="pong"></div>
	<div class="panel">
		Move with [ UP ], [ DOWN ]
	</div>
</body>
</html>
